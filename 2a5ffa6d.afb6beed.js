(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{147:function(e,t,i){"use strict";i.r(t),i.d(t,"frontMatter",(function(){return r})),i.d(t,"metadata",(function(){return b})),i.d(t,"rightToc",(function(){return l})),i.d(t,"default",(function(){return s}));var n=i(2),o=i(10),a=(i(0),i(160)),r={id:"github",title:"Github Actions"},b={id:"kubernetes-devops/github",isDocsHomePage:!1,title:"Github Actions",description:"Github Actions Demo Scenarios",source:"@site/docs/kubernetes-devops/github.md",permalink:"/demokit/docs/kubernetes-devops/github",editUrl:"https://github.com/azure/demokit/edit/master/docs/kubernetes-devops/github.md",sidebar:"sidebar",previous:{title:"Arc for Kubernetes",permalink:"/demokit/docs/kubernetes-devops/arc-for-kubernetes"},next:{title:"Azure DevOps",permalink:"/demokit/docs/kubernetes-devops/devops"}},l=[{value:"Github Actions Demo Scenarios",id:"github-actions-demo-scenarios",children:[]},{value:"Demo Steps",id:"demo-steps",children:[{value:"Github Actions Pipeline",id:"github-actions-pipeline",children:[]},{value:"Canary Deployment on AKS",id:"canary-deployment-on-aks",children:[]},{value:"Roll back on error",id:"roll-back-on-error",children:[]}]}],c={rightToc:l};function s(e){var t=e.components,i=Object(o.a)(e,["components"]);return Object(a.b)("wrapper",Object(n.a)({},c,i,{components:t,mdxType:"MDXLayout"}),Object(a.b)("h2",{id:"github-actions-demo-scenarios"},"Github Actions Demo Scenarios"),Object(a.b)("p",null,"Github devops demo leverages github actions to build application, generate docker image, push image to azure container registry, and deploy image to AKS. It includes below actions"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Github actions implemented pipleline"),Object(a.b)("li",{parentName:"ul"},"Canary deployment"),Object(a.b)("li",{parentName:"ul"},"Codeql to scan code triggered by push or schedule")),Object(a.b)("p",null,"This demo supports below scenarios"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"DevOps pipeline \u2013 build & deploy"),Object(a.b)("li",{parentName:"ul"},"Canary deployment on AKS"),Object(a.b)("li",{parentName:"ul"},"Roll back on error to successful deployment")),Object(a.b)("p",null,"To use this demo, follow below steps to open 3 webpages"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Open ",Object(a.b)("a",Object(n.a)({parentName:"li"},{href:"http://vote-github.k8s.devsecops.ink/"}),"webpage 1"),", this is sample vote demo application which is deployed to AKS already, currently, its version is ",Object(a.b)("inlineCode",{parentName:"li"},"Azure Voting App - Github Actions(v1)"),", highlight application version to your customer, lately the version will get changed to ",Object(a.b)("inlineCode",{parentName:"li"},"Azure Voting App \u2013 Github Actions(v2)")),Object(a.b)("li",{parentName:"ol"},"Open ",Object(a.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/devopsonazure/vote-github/blob/master/azure-vote/config_file.cfg"}),"webpage 2"),", this is sample application configuration file, we are going to change the configuration, rebuild and deploy it to AKS with github actions."),Object(a.b)("li",{parentName:"ol"},"Open ",Object(a.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/devopsonazure/vote-github/actions"}),"webpage 3"),", this is github actions page, the build & deploy workflows will be shown here.")),Object(a.b)("h2",{id:"demo-steps"},"Demo Steps"),Object(a.b)("h3",{id:"github-actions-pipeline"},"Github Actions Pipeline"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Go to webpage 2, click edit icon and change TITLE from ",Object(a.b)("inlineCode",{parentName:"li"},"Azure Voting App - Github Actions(v1)")," to ",Object(a.b)("inlineCode",{parentName:"li"}," Azure Voting App - Github Actions(v2)"),".\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-1.png",alt:"github-1"}))),Object(a.b)("li",{parentName:"ol"},"Click ",Object(a.b)("inlineCode",{parentName:"li"},"Commit changes")," button to commit the change.\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-2.png",alt:"github-2"}))),Object(a.b)("li",{parentName:"ol"},"Switch to webpage 3, refresh the page (might be multiple times), it will show github actions pipeline is started. It contains two actions, one is code scanning, another is build and deploy.\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-3.png",alt:"github-3"}))),Object(a.b)("li",{parentName:"ol"},"Click ",Object(a.b)("inlineCode",{parentName:"li"},"Build and deploy")," action, it has two stages, one is build and another is deploy, explain to your customer what github actions are doing right now, basically, those actions include building code, pushing image to azure container registry, and deploying the imaging to AKS.\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-4.png",alt:"github-4"}))),Object(a.b)("li",{parentName:"ol"},"Once build & deploy is completed, go to webpage 1, refresh it, you will see the version is changed to ",Object(a.b)("inlineCode",{parentName:"li"},"Azure Voting App \u2013 Github Actions(v2)"),Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-5.png",alt:"github-5"})))),Object(a.b)("h3",{id:"canary-deployment-on-aks"},"Canary Deployment on AKS"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Visit URL ",Object(a.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/devopsonazure/vote-github/edit/master/.github/workflows/build-deploy.yaml"}),"https://github.com/devopsonazure/vote-github/edit/master/.github/workflows/build-deploy.yaml"),", uncomment below lines then commit the change to github.\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-6.png",alt:"github-6"}))),Object(a.b)("li",{parentName:"ol"},"Visit URL ",Object(a.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/devopsonazure/vote-github/blob/master/azure-vote/config_file.cfg"}),"https://github.com/devopsonazure/vote-github/blob/master/azure-vote/config_file.cfg"),", modify version to v3, then commit change\u3002\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-7.png",alt:"github-7"}))),Object(a.b)("li",{parentName:"ol"},"Go to webpage 1, refresh page, the version of application should change to v3.\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-8.png",alt:"github-8"}))),Object(a.b)("li",{parentName:"ol"},"Now, open a new browser and use in-private mode, paste and visit same URL from webpage 1, it should display v2.\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-9.png",alt:"github-9"}))),Object(a.b)("li",{parentName:"ol"},"This is because we have enabled canary deployment, both versions exist in same cluster, AKS will handle the requests and distribute them to different version of services.  From AKS backend, it has two deploys",Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",Object(n.a)({parentName:"pre"},{className:"language-sh"}),"kubectl get deploy -n github \nNAME                        READY   UP-TO-DATE   AVAILABLE   AGE\nazure-vote-back             1/1     1            1           3d23h\nazure-vote-front            1/1     1            1           3d19h\nazure-vote-front-baseline   1/1     1            1           22m\nazure-vote-front-canary     1/1     1            1           22m\n")))),Object(a.b)("h3",{id:"roll-back-on-error"},"Roll back on error"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"Visit URL ",Object(a.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/devopsonazure/vote-github/edit/master/.github/workflows/build-deploy.yaml"}),"https://github.com/devopsonazure/vote-github/edit/master/.github/workflows/build-deploy.yaml"),', add "_failed" into below line, then commit change to github, it will trigger a failed deployment\n',Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-10.png",alt:"github-10"}))),Object(a.b)("li",{parentName:"ol"},"Go to ",Object(a.b)("a",Object(n.a)({parentName:"li"},{href:"https://github.com/devopsonazure/vote-github/actions"}),"https://github.com/devopsonazure/vote-github/actions"),", click the newest ",Object(a.b)("inlineCode",{parentName:"li"},"Build and deploy")," pipeline, wait for a while until the deployment get failed, show below screen to your customer, github actions pipeline will roll back on error to previous successful deployment.\n",Object(a.b)("img",Object(n.a)({parentName:"li"},{src:"../../img/kubernetes-devops/github-11.png",alt:"github-11"}))),Object(a.b)("li",{parentName:"ol"},"Go to webpage 1, refresh, it proves the service is still running and not affected by failed deployment.")))}s.isMDXComponent=!0},160:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return m}));var n=i(0),o=i.n(n);function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function b(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){a(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function l(e,t){if(null==e)return{};var i,n,o=function(e,t){if(null==e)return{};var i,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||(o[i]=e[i]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(o[i]=e[i])}return o}var c=o.a.createContext({}),s=function(e){var t=o.a.useContext(c),i=t;return e&&(i="function"==typeof e?e(t):b(b({},t),e)),i},p=function(e){var t=s(e.components);return o.a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},d=o.a.forwardRef((function(e,t){var i=e.components,n=e.mdxType,a=e.originalType,r=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=s(i),d=n,m=p["".concat(r,".").concat(d)]||p[d]||u[d]||a;return i?o.a.createElement(m,b(b({ref:t},c),{},{components:i})):o.a.createElement(m,b({ref:t},c))}));function m(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=i.length,r=new Array(a);r[0]=d;var b={};for(var l in t)hasOwnProperty.call(t,l)&&(b[l]=t[l]);b.originalType=e,b.mdxType="string"==typeof e?e:n,r[1]=b;for(var c=2;c<a;c++)r[c]=i[c];return o.a.createElement.apply(null,r)}return o.a.createElement.apply(null,i)}d.displayName="MDXCreateElement"}}]);